<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebGL Geometry and Rotation</title>
    <style>
        /* Basic styling */
        body { margin: 20px; font-family: sans-serif; }

        /* Layout */
        .container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
        }

        .canvas-container {
            flex: 0 0 auto;
        }

        /* Canvas styling */
        canvas {
            border: 1px solid black;
            display: block;
            cursor: grab;
            width: 600px;
            height: 600px;
        }
        canvas:active { cursor: grabbing; } /* Cursor when dragging */

        /* Controls styling */
        #controls {
            flex: 1 1 auto;
            border: 1px solid #ccc;
            padding: 15px;
            max-width: 400px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        #controls label { display: inline-block; min-width: 70px; margin-bottom: 5px;}
        #controls input[type=number] { width: 60px; margin-right: 10px;}
        #controls span { font-size: 0.8em; color: #555; }
        #controls h3 { margin-top: 10px; margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #controls input[type=range] { width: 150px; margin-right: 10px; vertical-align: middle; }
        #controls select { margin-bottom: 5px; }
        #projection-controls, #modifiers-controls { margin-top: 10px; }
        #modifiers-controls > div { margin-bottom: 15px; padding: 8px; background-color: #f5f5f5; border-radius: 4px; }
        .axis-controls { margin-top: 10px; margin-left: 20px; }
        .axis-control { margin-bottom: 10px; padding: 5px; background-color: #e9e9e9; border-radius: 3px; }
        .axis-control input[type=range] { width: 120px; }
        .axis-control label { font-weight: normal; }
        hr { margin: 15px 0; border: 0; border-top: 1px solid #ddd; }
        textarea { display: none; } /* Hide shader source textareas */
    </style>
</head>
<!-- InitWebGL now initializes everything -->
<body onload="InitWebGL();">

    <h1>WebGL Geometry & Rotation</h1>
    <p>Drag mouse on canvas to rotate the shape.</p>

    <!-- Flex container for layout -->
    <div class="container">
        <!-- Canvas container -->
        <div class="canvas-container">
            <!-- Canvas for WebGL rendering -->
            <canvas id="gl" width="600" height="600">
                WebGL is not supported! Fallback content.
            </canvas>
        </div>

        <!-- Controls Area -->
        <div id="controls">
            <h3>Shape</h3>
            <label for="shape">Type:</label>
            <!-- Select Dropdown -->
            <select id="shape" onchange="InitShaders();">
                <option selected>Triangle</option>
                <option>Quad</option>
                <option>Cube</option>
                <option>Cylinder</option>
            </select>
            <br><br>
            <!-- Div for dynamic UI elements (inputs) generated by JS -->
            <div id="ui">Generate UI for geometry here!</div>

        <hr>
        <!-- Projection Controls -->
        <div id="projection-controls">
            <h3>Projection</h3>
            <label for="fov">Field of View:</label>
            <input type="range" id="fov" min="10" max="120" value="45" onchange="UpdateProjection();">
            <span id="fov-value">45°</span>
            <br>
            <label for="near">Near Plane:</label>
            <input type="range" id="near" min="0.01" max="10" step="0.01" value="0.1" onchange="UpdateProjection();">
            <span id="near-value">0.1</span>
            <br>
            <label for="far">Far Plane:</label>
            <input type="range" id="far" min="10" max="1000" step="10" value="100" onchange="UpdateProjection();">
            <span id="far-value">100</span>
        </div>

        <hr>
        <!-- Modifiers Controls -->
        <div id="modifiers-controls">
            <h3>Modifiers</h3>

            <!-- Bend Modifier -->
            <div>
                <input type="checkbox" id="bend-toggle" onchange="UpdateModifiers();">
                <label for="bend-toggle"><strong>Bend</strong></label>

                <div class="axis-controls">
                    <!-- X Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="bend-x-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="bend-x-toggle">X Axis</label>
                        <br>
                        <input type="range" id="bend-x-angle" min="-45" max="45" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="bend-x-angle-value">0°</span>
                    </div>

                    <!-- Y Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="bend-y-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="bend-y-toggle">Y Axis</label>
                        <br>
                        <input type="range" id="bend-y-angle" min="-45" max="45" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="bend-y-angle-value">0°</span>
                    </div>

                    <!-- Z Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="bend-z-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="bend-z-toggle">Z Axis</label>
                        <br>
                        <input type="range" id="bend-z-angle" min="-45" max="45" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="bend-z-angle-value">0°</span>
                    </div>
                </div>
            </div>

            <!-- Twist Modifier -->
            <div>
                <input type="checkbox" id="twist-toggle" onchange="UpdateModifiers();">
                <label for="twist-toggle"><strong>Twist</strong></label>

                <div class="axis-controls">
                    <!-- X Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="twist-x-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="twist-x-toggle">X Axis</label>
                        <br>
                        <input type="range" id="twist-x-angle" min="-90" max="90" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="twist-x-angle-value">0°</span>
                    </div>

                    <!-- Y Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="twist-y-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="twist-y-toggle">Y Axis</label>
                        <br>
                        <input type="range" id="twist-y-angle" min="-90" max="90" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="twist-y-angle-value">0°</span>
                    </div>

                    <!-- Z Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="twist-z-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="twist-z-toggle">Z Axis</label>
                        <br>
                        <input type="range" id="twist-z-angle" min="-90" max="90" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="twist-z-angle-value">0°</span>
                    </div>
                </div>
            </div>

            <!-- Taper Modifier -->
            <div>
                <input type="checkbox" id="taper-toggle" onchange="UpdateModifiers();">
                <label for="taper-toggle"><strong>Taper</strong></label>

                <div class="axis-controls">
                    <!-- X Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="taper-x-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="taper-x-toggle">X Axis</label>
                        <br>
                        <input type="range" id="taper-x-amount" min="-0.5" max="0.5" step="0.01" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="taper-x-amount-value">0</span>
                    </div>

                    <!-- Y Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="taper-y-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="taper-y-toggle">Y Axis</label>
                        <br>
                        <input type="range" id="taper-y-amount" min="-0.5" max="0.5" step="0.01" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="taper-y-amount-value">0</span>
                    </div>

                    <!-- Z Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="taper-z-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="taper-z-toggle">Z Axis</label>
                        <br>
                        <input type="range" id="taper-z-amount" min="-0.5" max="0.5" step="0.01" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="taper-z-amount-value">0</span>
                    </div>
                </div>
            </div>

            <!-- Bulge Modifier -->
            <div>
                <input type="checkbox" id="bulge-toggle" onchange="UpdateModifiers();">
                <label for="bulge-toggle"><strong>Bulge</strong></label>

                <div class="axis-controls">
                    <!-- X Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="bulge-x-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="bulge-x-toggle">X Axis</label>
                        <br>
                        <input type="range" id="bulge-x-amount" min="0" max="1" step="0.01" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="bulge-x-amount-value">0</span>
                    </div>

                    <!-- Y Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="bulge-y-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="bulge-y-toggle">Y Axis</label>
                        <br>
                        <input type="range" id="bulge-y-amount" min="0" max="1" step="0.01" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="bulge-y-amount-value">0</span>
                    </div>

                    <!-- Z Axis -->
                    <div class="axis-control">
                        <input type="checkbox" id="bulge-z-toggle" onchange="UpdateModifiers();" disabled>
                        <label for="bulge-z-toggle">Z Axis</label>
                        <br>
                        <input type="range" id="bulge-z-amount" min="0" max="1" step="0.01" value="0" onchange="UpdateModifiers();" disabled>
                        <span id="bulge-z-amount-value">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vertex Shader Source with UV and Normal support -->
    <textarea id="vs" spellcheck="false">
precision mediump float;

// Attributes from VBO
attribute vec3 Pos;
attribute vec3 Color;
attribute vec2 TexCoord;
attribute vec3 Normal;

// Uniforms sent from JavaScript
uniform vec4 Angle;             // Rotation angles (x, y)
uniform mat4 uProjectionMatrix; // Projection matrix
uniform mat4 uViewMatrix;       // View matrix (camera)
uniform bool uUseTexture;       // Whether to use texture
uniform vec3 uLightDir;         // Light direction (normalized)
uniform vec3 uLightColor;       // Light color
uniform float uAmbientStrength; // Ambient light strength

// Varying outputs to fragment shader
varying vec3 vertexColor;
varying vec2 texCoord;
varying vec3 normal;
varying float lightIntensity;

void main() {
    // --- Rotation Matrix Calculations (Model Matrix) ---
    float coY = cos(Angle.y); float siY = sin(Angle.y);
    mat4 matY = mat4(vec4(coY, 0.0,-siY, 0.0), vec4(0.0, 1.0, 0.0, 0.0), vec4(siY, 0.0, coY, 0.0), vec4(0.0, 0.0, 0.0, 1.0));
    float coX = cos(Angle.x); float siX = sin(Angle.x);
    mat4 matX = mat4(vec4(1.0, 0.0, 0.0, 0.0), vec4(0.0, coX, siX, 0.0), vec4(0.0,-siX, coX, 0.0), vec4(0.0, 0.0, 0.0, 1.0));
    mat4 modelMatrix = matY * matX;

    // --- Final Position Calculation ---
    gl_Position = uProjectionMatrix * uViewMatrix * modelMatrix * vec4(Pos, 1.0);

    // Transform normal to world space using the same rotation matrices
    // Extract the 3x3 rotation part from the model matrix
    mat3 normalMatrix = mat3(modelMatrix);
    vec3 worldNormal = normalize(normalMatrix * Normal);

    // Calculate Lambertian lighting
    float diffuse = max(dot(worldNormal, uLightDir), 0.0);
    lightIntensity = uAmbientStrength + diffuse * (1.0 - uAmbientStrength);

    // Pass values to fragment shader
    vertexColor = Color;
    texCoord = TexCoord;
    normal = worldNormal;
}
    </textarea>

    <!-- Fragment Shader Source with Texture and Lighting -->
    <textarea id="fs" spellcheck="false">
precision mediump float;

// Inputs from vertex shader
varying vec3 vertexColor;
varying vec2 texCoord;
varying vec3 normal;
varying float lightIntensity;

// Uniforms
uniform bool uUseTexture;
uniform sampler2D uTexture;
uniform vec3 uLightColor;

void main() {
    // Base color (either from texture or vertex color)
    vec4 baseColor;

    if (uUseTexture) {
        baseColor = texture2D(uTexture, texCoord);
    } else {
        baseColor = vec4(vertexColor, 1.0);
    }

    // Apply Lambertian lighting
    vec3 litColor = baseColor.rgb * lightIntensity * uLightColor;

    // Set the final pixel color
    gl_FragColor = vec4(litColor, baseColor.a);
}
    </textarea>

    <!-- Link to the JavaScript file -->
    <script src="js/webgl.js" defer></script>
</body>
</html>